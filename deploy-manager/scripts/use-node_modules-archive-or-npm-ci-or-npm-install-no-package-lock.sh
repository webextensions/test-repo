#!/bin/bash

# cd to the folder containing this script
cd "$(dirname "$0")"

# cd to the project's root folder
cd ../..

var hash = generateHash('.nvmrc', 'package.json', 'package-lock.json');

if (backupWithHashExists(hash)) {
    restoreNode_ModulesFromBackup(hash);
} else {
    if (exists("package-lock.json")) {
        if (inSync('package-lock.json', 'package.json')) {
            try {
                run("npm ci");
                backupIfRequired('node_modules');
            } catch (e) {
                run("npm install --no-package-lock");
                backupIfRequired('node_modules');
            }
        } else {
            console.warn('Warning: Your package-lock.json is out of sync with package.json');
            try {
                run("npm install --no-package-lock");
                backupIfRequired('node_modules');
            } catch (e) {
                run("npm ci");
                backupIfRequired('node_modules');
            }
        }
    } else {
        run("npm install --no-package-lock");
        backupIfRequired('node_modules');
    }
}
